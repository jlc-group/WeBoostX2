{% extends "layouts/app.html" %}

{% block page_title %}Admin - Users{% endblock %}
{% block page_subtitle %}จัดการผู้ใช้ ระบบ WeBoostX 2.0{% endblock %}

{% block content %}
<div x-data="adminUsers()" x-init="init()" class="space-y-6">
    <!-- Header actions -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h3 class="text-lg font-semibold text-gray-800">การอนุมัติผู้ใช้ & สิทธิ์การใช้งาน</h3>
            <p class="text-sm text-gray-500">
                Admin สามารถอนุมัติผู้ใช้ที่สมัครใหม่ และเปลี่ยน Role ได้จากหน้านี้
            </p>
        </div>
        <div class="flex items-center gap-3">
            <button @click="loadUsers()" 
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-gray-200 text-sm font-medium text-gray-700 hover:bg-gray-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9M20 20v-5h-.581m-15.357-2a8.003 8.003 0 0015.357 2"/>
                </svg>
                รีเฟรช
            </button>
        </div>
    </div>

    <!-- Alerts -->
    <template x-if="error">
        <div class="p-4 rounded-xl bg-red-50 border border-red-100 text-sm text-red-700 flex items-start gap-2">
            <svg class="w-5 h-5 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 00-7.07 17.07L19.07 4.93A9.956 9.956 0 0012 2z"/>
            </svg>
            <span x-text="error"></span>
        </div>
    </template>

    <template x-if="success">
        <div class="p-4 rounded-xl bg-emerald-50 border border-emerald-100 text-sm text-emerald-700 flex items-start gap-2">
            <svg class="w-5 h-5 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span x-text="success"></span>
        </div>
    </template>

    <!-- Tabs -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
            <button @click="activeTab = 'pending'" 
                    :class="activeTab === 'pending' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                รออนุมัติ
                <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-medium"
                      :class="pendingUsers.length ? 'bg-primary-50 text-primary-700' : 'bg-gray-100 text-gray-500'">
                    <span x-text="pendingUsers.length"></span>
                </span>
            </button>
            <button @click="activeTab = 'all'" 
                    :class="activeTab === 'all' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                ผู้ใช้ทั้งหมด
                <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">
                    <span x-text="users.length"></span>
                </span>
            </button>
        </nav>
    </div>

    <!-- Pending Users Table -->
    <div x-show="activeTab === 'pending'">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <p class="text-sm text-gray-600">
                    ผู้ใช้ที่สมัครใหม่และรอการอนุมัติ
                </p>
                <span class="text-xs text-gray-400" x-show="loading">กำลังโหลดข้อมูล...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">อีเมล</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ชื่อ</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Role ที่จะให้</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">สถานะ</th>
                            <th class="px-4 py-2"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100" x-show="pendingUsers.length">
                        <template x-for="user in pendingUsers" :key="user.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-800" x-text="user.email"></td>
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    <span x-text="user.display_name || ((user.first_name || '') + ' ' + (user.last_name || '')) || '-'"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    <select x-model="user._selectedRole"
                                            class="text-sm border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:border-primary-500">
                                        <option value="viewer">Viewer (ผู้บริหาร / ดูอย่างเดียว)</option>
                                        <option value="content_creator">Content Creator</option>
                                        <option value="ad_manager">Ad Manager</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-50 text-yellow-700">
                                        รออนุมัติ
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button @click="approveUser(user)" 
                                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        อนุมัติ
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="!pendingUsers.length && !loading">
                            <td colspan="5" class="px-4 py-6 text-center text-sm text-gray-500">
                                ไม่มีผู้ใช้ที่รออนุมัติ
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- All Users Table -->
    <div x-show="activeTab === 'all'">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <p class="text-sm text-gray-600">ผู้ใช้ทั้งหมดในระบบ</p>
                    <select x-model="filterStatus"
                            @change="loadUsers()"
                            class="text-xs border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:border-primary-500">
                        <option value="">สถานะทั้งหมด</option>
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
                <span class="text-xs text-gray-400" x-show="loading">กำลังโหลดข้อมูล...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">อีเมล</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ชื่อ</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">สถานะ</th>
                            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100" x-show="users.length">
                        <template x-for="user in users" :key="user.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-800" x-text="user.email"></td>
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    <span x-text="user.display_name || ((user.first_name || '') + ' ' + (user.last_name || '')) || '-'"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    <select x-model="user.role"
                                            @change="updateRole(user)"
                                            class="text-sm border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:border-primary-500">
                                        <option value="viewer">Viewer</option>
                                        <option value="content_creator">Content Creator</option>
                                        <option value="ad_manager">Ad Manager</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="statusBadgeClass(user.status)">
                                        <span x-text="statusLabel(user.status)"></span>
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right text-xs text-gray-500">
                                    ID: <span x-text="user.id"></span>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="!users.length && !loading">
                            <td colspan="5" class="px-4 py-6 text-center text-sm text-gray-500">
                                ไม่มีข้อมูลผู้ใช้
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function adminUsers() {
    return {
        loading: false,
        error: null,
        success: null,
        activeTab: 'pending',
        pendingUsers: [],
        users: [],
        filterStatus: '',

        init() {
            this.ensureAuth();
            this.loadUsers();
        },

        ensureAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
            }
        },

        getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        },

        async loadUsers() {
            this.loading = true;
            this.error = null;
            this.success = null;

            try {
                // Pending users
                const pendingRes = await fetch('/api/v1/auth/users/pending', {
                    headers: this.getAuthHeaders()
                });
                const pendingData = await pendingRes.json();
                if (pendingData.success) {
                    this.pendingUsers = pendingData.data.map(u => ({
                        ...u,
                        _selectedRole: 'viewer'
                    }));
                } else {
                    this.error = pendingData.detail || 'โหลดรายชื่อผู้ใช้ที่รออนุมัติไม่สำเร็จ';
                }

                // All users
                let url = '/api/v1/auth/users';
                if (this.filterStatus) {
                    url += `?status=${this.filterStatus}`;
                }
                const usersRes = await fetch(url, {
                    headers: this.getAuthHeaders()
                });
                const usersData = await usersRes.json();
                if (usersData.success) {
                    this.users = usersData.data;
                } else {
                    this.error = usersData.detail || 'โหลดรายชื่อผู้ใช้ไม่สำเร็จ';
                }
            } catch (e) {
                console.error(e);
                this.error = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
            } finally {
                this.loading = false;
            }
        },

        async approveUser(user) {
            this.loading = true;
            this.error = null;
            this.success = null;
            try {
                const res = await fetch(`/api/v1/auth/users/${user.id}/approve?role=${user._selectedRole}`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    this.success = `อนุมัติผู้ใช้ ${user.email} เรียบร้อยแล้ว`;
                    await this.loadUsers();
                } else {
                    this.error = data.detail || 'อนุมัติไม่สำเร็จ';
                }
            } catch (e) {
                console.error(e);
                this.error = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
            } finally {
                this.loading = false;
            }
        },

        async updateRole(user) {
            this.loading = true;
            this.error = null;
            this.success = null;
            try {
                const res = await fetch(`/api/v1/auth/users/${user.id}/role?role=${user.role}`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    this.success = `อัปเดต Role ของ ${user.email} เป็น ${user.role} แล้ว`;
                } else {
                    this.error = data.detail || 'อัปเดต Role ไม่สำเร็จ';
                }
            } catch (e) {
                console.error(e);
                this.error = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
            } finally {
                this.loading = false;
            }
        },

        statusLabel(status) {
            switch (status) {
                case 'active': return 'Active';
                case 'pending': return 'Pending';
                case 'inactive': return 'Inactive';
                case 'suspended': return 'Suspended';
                default: return status;
            }
        },

        statusBadgeClass(status) {
            switch (status) {
                case 'active': return 'bg-emerald-50 text-emerald-700';
                case 'pending': return 'bg-yellow-50 text-yellow-700';
                case 'inactive': return 'bg-gray-100 text-gray-600';
                case 'suspended': return 'bg-red-50 text-red-700';
                default: return 'bg-gray-100 text-gray-600';
            }
        }
    }
}
</script>
{% endblock %}


